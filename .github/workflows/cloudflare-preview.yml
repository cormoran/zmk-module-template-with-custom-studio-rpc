name: Deploy Web UI Preview to Cloudflare Pages

on:
  # Manual trigger from pull request
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'Pull Request Number'
        required: false
        type: number
      project_name:
        description: 'Cloudflare Pages Project Name'
        required: false
        default: 'zmk-module-web-ui'
        type: string

# Allow only one concurrent deployment per PR
concurrency:
  group: >-
    cloudflare-preview-${{
      github.event.inputs.pr_number || github.ref_name
    }}
  cancel-in-progress: true

jobs:
  check-changes:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
      pr_number: ${{ steps.get-pr.outputs.pr_number }}
      pr_branch: ${{ steps.get-pr.outputs.pr_branch }}
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Get PR information
        id: get-pr
        run: |
          if [ -n "${{ github.event.inputs.pr_number }}" ]; then
            PR_NUMBER="${{ github.event.inputs.pr_number }}"
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

            # Get PR branch using GitHub API
            PR_DATA=$(gh pr view $PR_NUMBER --json headRefName)
            PR_BRANCH=$(echo "$PR_DATA" | jq -r '.headRefName')
            echo "pr_branch=$PR_BRANCH" >> $GITHUB_OUTPUT
          else
            # If triggered without PR number, check if current branch is a PR
            CURRENT_BRANCH="${GITHUB_REF#refs/heads/}"
            PR_NUMBER=$(gh pr list --head "$CURRENT_BRANCH" \
              --json number --jq '.[0].number' || echo "")

            if [ -n "$PR_NUMBER" ]; then
              echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
              echo "pr_branch=$CURRENT_BRANCH" >> $GITHUB_OUTPUT
            else
              echo "No PR found for current branch"
              echo "pr_number=" >> $GITHUB_OUTPUT
              echo "pr_branch=$CURRENT_BRANCH" >> $GITHUB_OUTPUT
            fi
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Check for web UI changes
        id: check
        run: |
          if [ -z "${{ steps.get-pr.outputs.pr_number }}" ]; then
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            echo "::notice::No PR number provided or found."
            echo "::notice::Skipping deployment."
            exit 0
          fi

          # Checkout the PR branch
          git fetch origin "${{ steps.get-pr.outputs.pr_branch }}"
          git switch "${{ steps.get-pr.outputs.pr_branch }}"

          # Check if web directory has changes compared to base branch
          BASE_BRANCH="main"
          git fetch origin $BASE_BRANCH

          # Get list of changed files in web directory
          CHANGED_FILES=$(git diff --name-only origin/$BASE_BRANCH...HEAD \
            -- web/ proto/ || true)

          if [ -n "$CHANGED_FILES" ]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "::notice::Web UI changes detected."
            echo "::notice::Proceeding with deployment."
            echo "Changed files:"
            echo "$CHANGED_FILES"
          else
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            echo "::notice::No web UI changes detected."
            echo "::notice::Skipping deployment."
          fi

  build-and-deploy:
    needs: check-changes
    if: needs.check-changes.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    defaults:
      run:
        working-directory: web
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v5
        with:
          ref: ${{ needs.check-changes.outputs.pr_branch }}

      - uses: actions/setup-node@v6
        with:
          node-version: 24

      - name: Install dependencies
        run: npm ci

      - name: Generate types from proto
        run: npm run generate

      - name: Run lint
        run: npm run lint

      - name: Build
        run: npm run build

      - name: Deploy to Cloudflare Pages
        id: deploy
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: >-
            ${{ github.event.inputs.project_name || 'zmk-module-web-ui' }}
          directory: web/dist
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ needs.check-changes.outputs.pr_branch }}

      - name: Comment PR with deployment URL
        if: needs.check-changes.outputs.pr_number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const prNumberStr = '${{
              needs.check-changes.outputs.pr_number
            }}';
            const prNumber = parseInt(prNumberStr);

            if (!prNumber || isNaN(prNumber)) {
              core.setFailed('Invalid PR number: ' + prNumberStr);
              return;
            }

            const deploymentUrl = '${{ steps.deploy.outputs.url }}';
            const aliasUrl = '${{ steps.deploy.outputs.alias }}';

            const comment = `## ðŸš€ Cloudflare Pages Deployment

            The web UI preview has been deployed!

            **Preview URL:** ${deploymentUrl}
            ${aliasUrl ? `**Alias URL:** ${aliasUrl}` : ''}

            This preview will be available until the PR is closed or a new deployment is triggered.

            ---
            <sub>Deployed from commit ${context.sha.substring(0, 7)}</sub>`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ðŸš€ Cloudflare Pages Deployment')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment
              });
            }
